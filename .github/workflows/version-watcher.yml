name: Version Watcher

on:
  workflow_dispatch:

  schedule:
    - cron: "0 4 * * *"

permissions:
  contents: write

jobs:
  watch:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Resolve versions + update config.toml
        run: |
          set -e

          PATCHES_URL="https://raw.githubusercontent.com/MorpheApp/morphe-patches/main/patches-list.json"

          YT_ARCHIVE="https://archive.org/download/jhc-apks/apks/com.google.android.youtube"
          YTM_ARCHIVE="https://archive.org/download/jhc-apks/apks/com.google.android.apps.youtube.music"

          echo "[+] Fetching Morphe patches"
          curl -s "$PATCHES_URL" > patches.json

          yt_versions=$(jq -r '
            .patches[]
            | (.compatiblePackages["com.google.android.youtube"]? // [])
            | .[]
          ' patches.json | sort -V)

          ytm_versions=$(jq -r '
            .patches[]
            | (.compatiblePackages["com.google.android.apps.youtube.music"]? // [])
            | .[]
          ' patches.json | sort -V)

          echo "[+] Fetching archive listings"
          yt_files=$(curl -s "$YT_ARCHIVE/" | grep -oP '[0-9]+\.[0-9]+\.[0-9]+')
          ytm_files=$(curl -s "$YTM_ARCHIVE/" | grep -oP '[0-9]+\.[0-9]+\.[0-9]+')

          latest_yt=""
          for v in $yt_versions; do
            if echo "$yt_files" | grep -qx "$v"; then
              latest_yt="$v"
            fi
          done

          latest_ytm=""
          for v in $ytm_versions; do
            if echo "$ytm_files" | grep -qx "$v"; then
              latest_ytm="$v"
            fi
          done

          [ -z "$latest_yt" ] && echo "No YouTube match" && exit 0
          [ -z "$latest_ytm" ] && echo "No Music match" && exit 0

          current_yt=$(grep -A3 '\[YouTube\]' config.toml | grep version | cut -d'"' -f2)
          current_ytm=$(grep -A3 '\[Music\]' config.toml | grep version | cut -d'"' -f2)

          echo "YT current : $current_yt"
          echo "YT latest  : $latest_yt"

          echo "Music current : $current_ytm"
          echo "Music latest  : $latest_ytm"

          changed=false

          if [ "$latest_yt" != "$current_yt" ]; then
            sed -i "/\[YouTube\]/,/archive-dlurl/ s/version = \".*\"/version = \"$latest_yt\"/" config.toml
            changed=true
          fi

          if [ "$latest_ytm" != "$current_ytm" ]; then
            sed -i "/\[Music\]/,/archive-dlurl/ s/version = \".*\"/version = \"$latest_ytm\"/" config.toml
            changed=true
          fi

          if [ "$changed" = true ]; then
            git config user.name github-actions
            git config user.email github-actions@github.com
            git add config.toml
            git commit -m "chore: auto bump YouTube $latest_yt / Music $latest_ytm"
            git push
          else
            echo "No changes"
          fi
